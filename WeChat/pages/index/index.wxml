<!-- pages/index/index.wxml -->
<view class="container">
<!-- å•†å“æµè§ˆåŒºåŸŸ -->
<view wx:if="{{!isNegotiating}}">
  <!-- æœç´¢æ¡† -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <input 
        class="search-input"
        type="text"
        placeholder="Enter product name, ID, or price"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearchConfirm"
      />
      <view wx:if="{{searchKeyword}}" class="clear-btn" bindtap="clearSearch">
        <text class="clear-icon">Ã—</text>
      </view>
      <view wx:else class="search-icon">
        <text class="search-icon-text">ğŸ”</text>
      </view>
    </view>
  </view>
  
  <!-- æœç´¢æç¤º -->
  <view wx:if="{{searching}}" class="search-info">
    <text>æœç´¢"{{searchKeyword}}"</text>
    <text wx:if="{{displayedProducts.length > 0}}">æ‰¾åˆ° {{displayedProducts.length}} ä¸ªå•†å“</text>
  </view>
  
  <!-- å•†å“åˆ—è¡¨ -->
  <scroll-view 
    scroll-y 
    class="product-list"
    bindscrolltolower="onReachBottom"
  >
    <!-- å•†å“é¡¹ç½‘æ ¼å¸ƒå±€ -->
    <view class="product-grid">
      <block wx:for="{{displayedProducts}}" wx:key="id">
        <view 
          class="product-item {{selectedProduct && selectedProduct.id === item.id ? 'selected' : ''}}"
          bindtap="selectProduct"
          data-product="{{item}}"
        >
          <image src="{{item.image}}" class="product-image" mode="aspectFill"></image>
          <view class="product-info">
            <view class="product-name">{{item.name}}</view>
            <view class="product-description">{{item.description}}</view>
            <view class="product-price">Â¥{{item.basePrice}}</view>
          </view>
        </view>
      </block>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤šäº† -->
    <view wx:if="{{!hasMore && !searching && displayedProducts.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šå•†å“äº†</view>
    
    <!-- æ— æœç´¢ç»“æœ -->
    <view wx:if="{{searching && displayedProducts.length === 0 && !loading}}" class="no-results">
      <view class="no-data-icon">ğŸ“¦</view>
      <text class="no-results-title">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•†å“</text>
      <text class="no-results-subtitle">è¯·å°è¯•å…¶ä»–å…³é”®è¯</text>
    </view>
  </scroll-view>
  
  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <view wx:if="{{selectedProduct}}" class="selected-product">
      å·²é€‰: {{selectedProduct.name}} (Â¥{{selectedProduct.basePrice}})
    </view>
    <button 
      class="negotiate-btn {{selectedProduct ? 'active' : 'disabled'}}"
      bindtap="startNegotiation"
      disabled="{{!selectedProduct}}"
    >
    Start negotiating
    </button>
  </view>
</view>
<!-- è°ˆåˆ¤åŒºåŸŸ - é‡æ–°è®¾è®¡å¸ƒå±€ -->
<view wx:else class="negotiation-container">
  <!-- é¡¶éƒ¨å›ºå®šæ  - åªä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ -->
  <view class="negotiation-top-bar">
    <!-- ç³»ç»Ÿæ¶ˆæ¯ - å›ºå®šåœ¨é¡¶éƒ¨ -->
    <view wx:if="{{messages[0] && messages[0].role === 'system'}}" class="system-message-container">
      <view class="message">
        <view class="message-header">
          <text class="role-label">System prompt</text>
          <text class="timestamp">{{messages[0].timestamp}}</text>
        </view>
        <view class="message-content">{{messages[0].content}}</view>
      </view>
    </view>
  </view>
  
  <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
  <scroll-view scroll-y scroll-top="{{scrollTop}}" class="chat-container">
    <block wx:for="{{messages}}" wx:key="id" wx:if="{{index > 0 || messages[0].role !== 'system'}}">
      <view class="message-container {{item.role}}">
        <view class="message">
          <view class="message-header">
            <text class="role-label">
              <text wx:if="{{item.role === 'user'}}">Me</text>
              <text wx:elif="{{item.role === 'bot'}}">å•†å®¶</text>
              <text wx:else>System Agent</text>
            </text>
            <text class="timestamp">{{item.timestamp}}</text>
          </view>
          <view class="message-content">{{item.content}}</view>
        </view>
      </view>
    </block>
  </scroll-view>
  
  <!-- è¾“å…¥åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ï¼ŒåŒ…å«ç»“æŸæŒ‰é’® -->
  <view class="input-area" wx:if="{{negotiationStatus === 'ongoing'}}">
    <input 
      class="chat-input"
      value="{{inputValue}}" 
      bindinput="onInput" 
      placeholder="Enter your offer or request..."
      focus="{{autoFocus}}"
      confirm-type="send"
      bindconfirm="sendMessage"
    />
    <button class="send-btn" bindtap="sendMessage">Send</button>
    <button class="end-btn" bindtap="endNegotiation">Terminate</button>
  </view>
</view>
</view>